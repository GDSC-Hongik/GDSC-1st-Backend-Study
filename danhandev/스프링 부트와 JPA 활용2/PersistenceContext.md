# EntityManager

EntityManagerëŠ” ìë°” ê°ì²´(@Entity)ë¥¼ DBì— ì €ì¥ëœ ë°ì´í„°ì™€ ë§µí•‘í•´ì£¼ëŠ” ORM ê¸°ìˆ ì„ ì •ì˜í•œ ì¸í„°í˜ì´ìŠ¤ì´ë‹¤.

@Entityë¥¼ ë‹¬ê³  ìˆëŠ” Entity ê°ì²´ë“¤ì„ ê´€ë¦¬í•œë‹¤. ì‹¤ì œ DB í…Œì´ë¸”ê³¼ ë§¤í•‘í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°íšŒ/ìˆ˜ì •/ì €ì¥í•˜ëŠ” ì¤‘ìš”í•œ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•œë‹¤. PersistenceContextë¼ëŠ” ë…¼ë¦¬ì  ì˜ì—­ì„ ë‘ì–´, ë‚´ë¶€ì ìœ¼ë¡œ Entityì˜ ìƒì• ì£¼ê¸°ë¥¼ ê´€ë¦¬í•œë‹¤.

```java
@Repository
public class JpaRepository {

	@PersistenceContext
	private EntityManage em;
}
```

# PersistenceContext

ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” Entityë¥¼ ì˜êµ¬ ì €ì¥í•˜ëŠ” í™˜ê²½ìœ¼ë¡œ ë…¼ë¦¬ì ì¸ ê°œë…ì´ë‹¤. ì–´í”Œë¦¬ì¼€ì´ì…˜ê³¼ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ì´ì—ì„œ ê°ì²´ë¥¼ ë³´ê´€í•˜ëŠ” ê°€ìƒì˜ DB ì—­í• ì„ í•œë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.

# Entityì˜ ìƒì•  ì£¼ê¸°

Entity ê°ì²´ëŠ” ë„¤ ê°€ì§€ ìƒíƒœ ì¤‘ í•˜ë‚˜ì˜ ìƒíƒœë¥¼ ê°€ì§„ë‹¤.

![](https://user-images.githubusercontent.com/78093844/203713394-b8b7bcc8-60d6-4fac-9e9a-4ea40118c622.png)

### New/Transient ë¹„ì˜ì† ìƒíƒœ

ì²˜ìŒ ìƒì„±ë˜ì–´ ì•„ì§ EntityManagerì˜ ê´€ë¦¬ë¥¼ ë°›ì§€ ì•ŠëŠ” ìƒíƒœì´ë‹¤ ìˆœìˆ˜í•œ ìë°” ê°ì²´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤.

### Managed ì˜ì† ìƒíƒœ

EntityManagerì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœì´ë‹¤. EntityManagerì—ì„œ persist() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê±°ë‚˜ JPQLë¡œ ì¿¼ë¦¬ëœ Entity ê°ì²´ëŠ” ì´ ìƒíƒœì— ë†“ì´ê²Œ ëœë‹¤. EntityManager ë‚´ë¶€ì˜ PersistenceContextì— ë°ì´í„°ê°€ ì €ì¥ëœ ì¼ì¢…ì˜ ìºì‹± ìƒíƒœì— ê°€ê¹ë‹¤. DBì— ì‹¤ì œ ë°ì´í„°ê°€ ì €ì¥ëœ ê²ƒì€ ì•„ë‹ˆë‹¤.

### Detached ì¤€ì˜ì† ìƒíƒœ

EntityMangerê°€ ë” ì´ìƒ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ìƒíƒœì´ë‹¤. PersistenceContextì— ì €ì¥ë˜ì—ˆë‹¤ê°€ ë¶„ë¦¬ëœ ìƒíƒœì´ë‹¤.

### Removed ì‚­ì œ ìƒíƒœ

EntityManagerì˜ PersistenceContextì—ì„œ ì™„ì „íˆ ì‚­ì œëœ ìƒíƒœì´ë‹¤. Detached ìƒíƒœì™€ ë‹¬ë¦¬, DBì— ë§µí•‘ëœ ë°ì´í„°ë„ í•¨ê»˜ ì œê±°ëœë‹¤.

```java
@Repository
pubilc class JpaRepository {

	@PersistenceContext
	private EntityManger em;

	public Long save(Member member) { // new
		em.persist(member);             // managed
		em.detach(member);              // detached
		return member.getId();
	}
}
```

## EntityManagerì˜ ì´ì 

EntityMangerëŠ” ë°ì´í„°ë² ì´ìŠ¤ì™€ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ì´ì— ìœ„ì¹˜í•˜ì—¬ í¸ë¦¬í•œ ê¸°ëŠ¥ë“¤ì„ ì œê³µí•œë‹¤. ëŒ€í‘œì ì¸ íŠ¹ì§•ìœ¼ë¡œëŠ” First Level Cache, Identity, Write-Behind, Dirty Check, Lazy Loading ë“±ì´ ìˆë‹¤.

### First Level Cache 1ì°¨ ìºì‹œ

ë°ì´í„°ë² ì´ìŠ¤ì™€ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ì´ì— ìœ„ì¹˜í•˜ê¸° ë•Œë¬¸ì— ìºì‹± ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.  PersistenceContextì— ë“±ë¡ëœ Entity ê°ì²´ì˜ @Idê°€ ë¶™ì€ í•„ë“œ ê°’ì„ ì‚¬ìš©í•˜ë©° Map<Id, Entity> í˜•íƒœë¡œ ì €ì¥í•œë‹¤.

ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°ì´í„° ì¡°íšŒë¥¼ ìš”ì²­í•˜ë©´, EntityManagerëŠ” ë¨¼ì € ë‚´ë¶€ì— ìºì‹±ëœ Entityê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤. ë°ì´í„°ê°€ ì¡´ì¬í•˜ë©´ DBì— ì¿¼ë¦¬ë¥¼ ì „ì†¡í•˜ì§€ ì•Šê³ , ìºì‹±ëœ Entityë¥¼ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì— ì¿¼ë¦¬ ì„±ëŠ¥ì´ ìµœì í™”ëœë‹¤. ë„¤íŠ¸ì›Œí¬ ë¦¬ì†ŒìŠ¤ë¥¼ ì•„ë‚„ ìˆ˜ ìˆë‹¤.

1ì°¨ ìºì‹œëŠ” íŠ¸ëœì­ì…˜ ë‹¨ìœ„ë¡œ ìœ ì§€ëœë‹¤.


1. 1ì°¨ ìºì‹œì—ì„œ ì¡°íšŒ
2. 1ì°¨ ìºì‹œì—ì„œ ì—†ì„ ê²½ìš°
      DBì—ì„œ ì¡°íšŒ â†’ 1ì°¨ ìºì‹œì— ì €ì¥ â†’ ë°˜í™˜

### Identity ë™ì¼ì„± ë³´ì¥

EntityMangerëŠ” repeatable read ë“±ê¸‰ì˜ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œë„ ì œê³µí•œë‹¤. 1ì°¨ ìºì‹œë¡œ Entityë¥¼ ì €ì¥í•˜ê¸° ë•Œë¬¸ì— ë™ì¼í•œ Entityë¥¼ ìš”ì²­í•  ë•ŒëŠ” ë™ì¼í•œ Entityë¥¼ ë°˜í™˜í•¨ì„ ë³´ì¥í•œë‹¤.

> Repeatable read ë“±ê¸‰ 
> - íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì´ë€ ì—¬ëŸ¬ê°œì˜ íŠ¸ëœì­ì…˜ì´ ì²˜ë¦¬ë  ë•Œì— ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œ ë³€ê²½ ë° ì¡°íšŒí•˜ëŠ” ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í• ì§€ì— ëŒ€í•œ ìˆ˜ì¤€ ì œí•œ
> - íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì€ 0~3ë‹¨ê³„ ì¤‘ 2ë‹¨ê³„
> - íŠ¸ëœì­ì…˜ì´ ì™„ë£Œë  ë•Œê¹Œì§€ í•œ ë²ˆ SELECTí•œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ SELECTí•´ë„ ê²°ê³¼ëŠ” ê°™ìŒì„ ë³´ì¥
>

```java
Member a = em.find(Member.class, "member1");
Member b = em.find(Member.class, "member1");

System.out.println(a == b) // ë™ì¼ì„± ë³´ì¥
```

### Write-Behind ì“°ê¸° ì§€ì—°

EntityManagerê°€ ìƒì„±ëœ í›„ transaction.begin()ìœ¼ë¡œ íŠ¸ëœì ì…˜ì„ ì‹œì‘í•œë‹¤. ê·¸ ì‚¬ì´ì— ë°ì´í„°ë¥¼ ì‚½ì…/ìˆ˜ì •/ì¡°íšŒ ë“±ì˜ ì‘ì—…ì„ í•œë‹¤. ì´ ì‘ì—…ë“¤ì€ ì»¤ë°‹í•˜ì§€ ì „ì´ë¯€ë¡œ DBì— ë°˜ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤. ì‹œì‘í•œ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ì§€ ì•Šìœ¼ë©´ DBì— ì „ë‹¬ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì“°ê¸° ì§€ì—°ì´ ë°œìƒí•œë‹¤.

í•„ìš”í•œ ì‘ì—…ë“¤ì„ ëª¨ë‘ ëª¨ì•„ í•œë²ˆì— DBì— SQLì„ ë³´ë‚´ê³  íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•´ë²„ë¦¬ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ì˜ ë½ì´ í’€ë¦´ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì§€ ì•Šì•„ë„ ëœë‹¤. ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì—ì„œ ì˜ë„ì¹˜ ì•Šì€ ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš° roll-backì´ ìš©ì´í•˜ë©°, ë„¤íŠ¸ì›Œí¬ ë¹„ìš©ì„ ìµœì†Œí™”í•  ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì„ ì§€ë‹Œë‹¤.

```java
EntityManager em = emf.createEntityManager();
EntityTransaction transaction = em.getTransaction();
//ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ë°ì´í„° ë³€ê²½ì‹œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•´ì•¼ í•œë‹¤.
transaction.begin(); // [íŠ¸ëœì­ì…˜] ì‹œì‘
em.persist(memberA);
em.persist(memberB);

//ì—¬ê¸°ê¹Œì§€ INSERT SQLì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë³´ë‚´ì§€ ì•ŠëŠ”ë‹¤.
//ì»¤ë°‹í•˜ëŠ” ìˆœê°„ ë°ì´í„°ë² ì´ìŠ¤ì— INSERT SQLì„ ë³´ë‚¸ë‹¤.
transaction.commit(); // [íŠ¸ëœì­ì…˜] ì»¤ë°‹
```

### Dirty Check ë³€ê²½ ê°ì§€

EntityManagerì— ë“±ë¡ëœ Entityì— ìˆ˜ì •ì´ ë°œìƒí•˜ë©´, íŠ¸ëœì­ì…˜ì´ commitë˜ëŠ” ì‹œì ì—ì„œ ë‚´ë¶€ì ìœ¼ë¡œ flushë¥¼ í˜¸ì¶œí•œë‹¤. Entityë¥¼ PersistenceContextì— ë³´ê´€í•  ë•Œ ìµœì´ˆ ìƒíƒœë¥¼ ë³µì‚¬í•´ ì €ì¥í•´ë‘ëŠ” ë° ì´ë¥¼ ìŠ¤ëƒ…ìƒ·ì´ë¼ê³  í•œë‹¤. ì´ ìŠ¤ëƒ…ìƒ·ê³¼ Entityë¥¼ ë¹„êµí•´ ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•˜ê³  UPDATE ì¿¼ë¦¬ë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰í•œë‹¤. ì´ ì¿¼ë¦¬ëŠ” flushì˜ ì§ì ‘ í˜¸ì¶œì´ë‚˜ commitì„ í†µí•´ DBì— ë°˜ì˜ëœë‹¤.

<aside>
ğŸ’¡ flushëŠ” PersistenceContextì˜ ë³€ê²½ ë‚´ìš©ì„ DBì— ë™ê¸°í™”í•˜ëŠ” ì‘ì—…

</aside>

```java
EntityManager em = emf.createEntityManager();
EntityTransaction transaction = em.getTransaction();
transaction.begin(); // [íŠ¸ëœì­ì…˜] ì‹œì‘
// ì˜ì† ì—”í‹°í‹° ì¡°íšŒ
Member memberA = em.find(Member.class, "memberA");
// ì˜ì† ì—”í‹°í‹° ë°ì´í„° ìˆ˜ì •
memberA.setUsername("hi");
memberA.setAge(10);

//em.update(member) ì´ëŸ° ì½”ë“œê°€ ì—†ì–´ë„ ëœë‹¤!
transaction.commit(); // [íŠ¸ëœì­ì…˜] ì»¤ë°‹
```

### Lazy Loading

@ManyToOne ê°™ì´ ë‹¤ëŒ€ì¼ ê´€ê³„ë¥¼ ê°€ì§„ Entityë¥¼ ì¡°íšŒí•  ë•Œ, ì‹¤ì œë¡œ í•´ë‹¹ Entityì˜ ë°ì´í„°ë¥¼ ì§ì ‘ ì ‘ê·¼í•˜ëŠ” ì‹œì ì— ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì„ ì˜ë¯¸í•œë‹¤.SELECTì‹œ í•œë²ˆì— Join í•´ì„œ ë‹¤ ê°€ì ¸ì˜¤ì§€ ì•Šê³  í”„ë¡ì‹œë¡œ ë°˜í™˜í•œ í›„, ë§¤í•‘ëœ ì—”í‹°í‹°ë¥¼ ì‚¬ìš©í•´ì•¼ í•  ë•Œ ë‹¤ì‹œ ì¡°íšŒí•´ì„œ ê°€ì ¸ì˜¨ë‹¤. Lazy Loadingì„ í†µí•´ EntityManagerëŠ” ë¶ˆí•„ìš”í•œ ì¿¼ë¦¬ë¥¼ ìµœì†Œí™”í•œë‹¤.