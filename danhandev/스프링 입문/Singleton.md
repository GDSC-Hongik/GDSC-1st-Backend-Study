## 싱글톤 패턴

- 웹 애플리케이션은 수백 ~ 수천번의 요청을 받는다. 요청이 올 때마다 객체를 생성해서 반환하면 JVM에 존재하는 객체가 많아지고 메모리 낭비도 심해진다. 생성하는데 시간이 걸리기 때문에 시간 효율도 떨어진다.
- 요청할 때마다 객체가 생성되는 비효율적인 문제점을 개선하는 패턴이 바로 싱글톤 패턴이다.
- JVM 내에서 사용되는 인스턴스 객체가 단 하나임으로 보장하는 패턴이다. 객체하나를 재사용해 필요한 일들을 모두 처리한다.

### 주의점

- 객체 인스턴스가 2개 이상 생성되지 않도록 생성자에 private 접근 제어자를 지정한다. 최초 1회 생성되고, 그 이후 어디서도 해당 인스터스를 생성할 수 없다.
- 유일한 단일 객체를 반환할 수 있는 getInstance() 정적 메서드를 만들고, 이 메서드를 통해서만 항상 같은 싱글톤 객체를 불러온다.

### 문제점

- 구현에 필요한 코드가 많아진다
    - 싱글톤 객체를 불러오기 위한 메서드..
    - 각 클래스에 new 키워드로 객체 넣기..
- DIP를 위반한다.
    - 싱글톤 객체는 컴파일 이전에 개발자가 정한 구현체가 정해진다. 특정 클래스가 특정 객체에 강하게 결합되어 있어 DI를 할 수 없다.
    - 구현 클래스에 의존하지 말고 인터페이스에 의존해야 한다는 의존관계 역전 원칙 DIP를 위반한다.
- DIP를 위반하기 때문에 OCP도 위반할 가능성이 높다
    - 싱글톤 객체를 다른 타입의 구체로 사용할 경우, 설정 정보 이외 메인 코드들의 변경이 필요하다.
    - 기존의 코드를 변경하지 않고 확장할 수 없어 개방 폐쇄 원칙 OCP를 위반한다.
- 테스트 하기 어렵다
    - 컴파일 이전에 이미 초기값들이 설정되어 있어 유연한 테스트가 힘들다.
- 자식 클래스를 만들기 어렵다.
    - 내부적으로 private 생성자를 가져 자식 클래스에서 이 생성자를 이용할 수 없다. 따라서 확장성 관점에서 좋지 않다.

## 스프링 컨테이너

- 스프링 컨테이너는 싱글톤 패턴의 단점을 해결하고 장점만을 가져와 싱글톤 컨테이너로 동작한다. (100% 싱글톤 컨테이너는 아니다. 어떤 Bean Scope를 사용하냐에 따라 달라질 수있다. 예를 들어 ProtoType Scope, Request Scope..)
- 싱글톤 컨테이너를 사용하면 싱글톤 패턴을 적용하지 않아도 싱글톤으로 객체들을 관리할 수 있다. 싱글톤 패턴에서 Private 생성자나 초기 설정값을 정하면서 DIP, OCP를 위반했던 단점을 개선하는데 도움이 된다.

### 어떻게 싱글톤을 보장하지?
<img width="706" alt="image" src="https://user-images.githubusercontent.com/78093844/194270886-620cbbfe-c6f3-4d82-8248-e1432939d9f6.png">

- 결론부터 말하면 `@Configuration`을 이용한 CGLIB라는 바이트코드 조작 라이브러리를 사용하기 때문에 싱글톤이 보장된다.
- 스프링은 CGLIB를 사용해 AppConfig 클래스를 상속하는 임의의 클래스를 생성한다.
- 스프링은 컨테이너의 설정 파일로 AppConfig를 사용하지 않는다. 대신 AppConfig를 상속받은 새로운 인스턴스(CGLIB)를 사용한다. `@Configuration`이 지정된 클래스의 빈을 스프링 컨테이너에 등록할 때 이 클래스를 스프링 빈으로 등록한다.
- AppConfig@CGLIB의 내부에서는 Bean에 등록된 메서드를 오버라이드한다. 오버라이드된 메서드는 중복 객체를 생성하지 않고, 기존 객체를 공유한다. 싱글톤을 보장하도록 메서드 기능을 오버라이드하는 것이다.
- 내부 동작 방식은 복잡하지만 간단히 말하면 빈이 이미 스프링 컨테이너에 등록되어 있으면 찾아서 반환하고, 없다면 기족 로직을 호출해서 새로운 빈을 생성하고 컨테이너에 등록한다. 이 방식으로 싱글톤을 보장한다.

### 정리

- 스프링 컨테이너가 싱글톤을 보장하는 원리는 CGLIB에 있다.
- @Configuration이 적용된 스프링 컨테이너에서 CGLIB 기술이 적용된다.

## 싱글톤 패턴의 싱글톤, 스프링의 싱글톤 차이점

- 싱글톤 패턴의 싱글톤은 클래서로더에 의해 구현되고, 스프링의 싱글톤은 스프링 컨테이너에 의해 구현된다.
- 싱글톤 패턴의 싱글톤은 코드 전체에서, 스프링의 싱글톤은 스프링 컨테이너 내부에서 보장된다.